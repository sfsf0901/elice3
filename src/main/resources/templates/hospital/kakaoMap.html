<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/layout}">
<head>
    <meta charset="UTF-8">
    <title>ì¹´ì¹´ì˜¤ ì§€ë„ - ë³‘ì› ê²€ìƒ‰ ë° í‘œì‹œ</title>

    <style>
        #map {
            width: 100%;
            height: 500px;
            background-color: #f5f5f5;
        }
        #search-container {
            margin-bottom: 10px;
        }
    </style>

    <!-- âœ… ì¹´ì¹´ì˜¤ ì§€ë„ API ë¡œë“œ -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=4b49a140b08c89cf9a1287842b76acfc&libraries=services"></script>
</head>
<body>
<div layout:fragment="content">
    <h2>ğŸ“ ì§€ë„ì—ì„œ ë³‘ì› ì°¾ê¸°</h2>

    <!-- âœ… ê²€ìƒ‰ ì…ë ¥ì°½ + ë²„íŠ¼ í•œ ì¤„ ì •ë ¬ -->
    <div id="search-container" class="d-flex mt-4">
        <input type="text" class="form-control me-2" id="search-input" placeholder="ë³‘ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex: 1; min-width: 0;">
        <button type="button" class="btn btn-primary" style="white-space: nowrap;" onclick="searchHospitalByName()">ê²€ìƒ‰</button>
    </div>


    <div class="mt-4" id="map"></div>

    <script>
        let map, infowindow;
        let hospitalMarkers = [];

        function initMap(lat, lng) {
            console.log(`ì‚¬ìš©ì ìœ„ì¹˜: ${lat}, ${lng}`);

            const userLocation = new kakao.maps.LatLng(lat, lng);
            const mapContainer = document.getElementById('map');
            const mapOptions = {
                center: userLocation,
                level: 5
            };

            // ì§€ë„ ìƒì„±
            map = new kakao.maps.Map(mapContainer, mapOptions);
            infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });

            // ì´ˆê¸° ë³‘ì› ê²€ìƒ‰
            searchNearbyHospitals();

            // âœ… ì§€ë„ ì´ë™ í›„ ìƒˆë¡œìš´ ì¤‘ì‹¬ ì¢Œí‘œë¡œ ë³‘ì› ê²€ìƒ‰
            kakao.maps.event.addListener(map, 'idle', function () {
                console.log("ğŸ›  ì§€ë„ ì´ë™ í›„ ê²€ìƒ‰ ì‹¤í–‰");
                searchNearbyHospitals();
            });
        }

        function getUserLocation() {
            console.log("ğŸ“ ì‚¬ìš©ì ìœ„ì¹˜ ì°¾ëŠ” ì¤‘...");
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        initMap(lat, lng);
                    },
                    function () {
                        console.error("âŒ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ. ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸ ì‹œì²­) ì‚¬ìš©");
                        initMap(37.5665, 126.9780);
                    }
                );
            } else {
                console.error("âŒ ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ.");
                initMap(37.5665, 126.9780);
            }
        }

        function searchNearbyHospitals() {
            console.log("ğŸ¥ ë³‘ì› ê²€ìƒ‰ ì‹œì‘");

            const places = new kakao.maps.services.Places();
            const bounds = map.getBounds(); // í˜„ì¬ ì§€ë„ ë²”ìœ„ ê°€ì ¸ì˜¤ê¸°
            console.log("ğŸ—º ê²€ìƒ‰ ë²”ìœ„:", bounds);

            places.keywordSearch("ë³‘ì›", function (data, status) {
                if (status === kakao.maps.services.Status.OK) {
                    console.log(`âœ… ê²€ìƒ‰ëœ ë³‘ì› ê°œìˆ˜: ${data.length}`);

                    removeMarkers(); // ê¸°ì¡´ ë§ˆì»¤ ì œê±°

                    data.forEach(hospital => {
                        addHospitalMarker(hospital);
                    });
                } else {
                    console.log("âŒ ë³‘ì› ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ");
                }
            }, {
                bounds: map.getBounds() // ğŸ“Œ í˜„ì¬ ë³´ì´ëŠ” ì§€ë„ ì˜ì—­ ë‚´ì—ì„œ ê²€ìƒ‰
            });
        }

        function searchHospitalByName() {
            const hospitalName = document.getElementById("search-input").value.trim();
            if (hospitalName === "") {
                alert("ë³‘ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");
                return;
            }

            console.log(`ğŸ” "${hospitalName}" ê²€ìƒ‰ ì¤‘...`);
            const places = new kakao.maps.services.Places();

            places.keywordSearch(hospitalName, function (data, status) {
                if (status === kakao.maps.services.Status.OK) {
                    console.log(`âœ… "${hospitalName}" ê²€ìƒ‰ ê²°ê³¼ ${data.length}ê°œ`);

                    removeMarkers(); // ê¸°ì¡´ ë§ˆì»¤ ì œê±°

                    const hospital = data[0]; // ì²« ë²ˆì§¸ ê²€ìƒ‰ ê²°ê³¼ ì‚¬ìš©
                    const hospitalPosition = new kakao.maps.LatLng(hospital.y, hospital.x);

                    // ì§€ë„ ì¤‘ì‹¬ ì´ë™
                    map.setCenter(hospitalPosition);
                    map.setLevel(3); // ì¤Œ í™•ëŒ€

                    addHospitalMarker(hospital);
                } else {
                    alert("âŒ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
            });
        }

        function addHospitalMarker(hospital) {
            const hospitalPosition = new kakao.maps.LatLng(hospital.y, hospital.x);
            const marker = new kakao.maps.Marker({
                position: hospitalPosition,
                map: map
            });

            kakao.maps.event.addListener(marker, 'click', function () {
                const content = `
                    <div style="padding:5px;font-size:14px;">
                        <strong>${hospital.place_name}</strong><br>
                        ${hospital.road_address_name || hospital.address_name} <br>
                        <a href="${hospital.place_url}" target="_blank" style="color:blue; text-decoration:underline;">
                            ğŸ‘‰ ìƒì„¸ ì •ë³´ ë³´ê¸°
                        </a>
                    </div>`;
                infowindow.setContent(content);
                infowindow.open(map, marker);
            });

            hospitalMarkers.push(marker);
        }

        function removeMarkers() {
            hospitalMarkers.forEach(marker => marker.setMap(null));
            hospitalMarkers = [];
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
        window.onload = getUserLocation;
    </script>
</div>
</body>
</html>
