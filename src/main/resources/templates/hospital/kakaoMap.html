<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/layout}">
<head>
    <meta charset="UTF-8">
    <title>ì¹´ì¹´ì˜¤ ì§€ë„ - ë³‘ì› ê²€ìƒ‰ ë° í‘œì‹œ</title>

    <style>
        #map {
            width: 100%;
            height: 500px;
            background-color: #f5f5f5;
        }
        .search-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            width: 100%;
        }
        .search-box {
            position: relative;
            width: 100%;
        }
        .search-input {
            width: 100%;
            padding: 14px 20px;
            padding-right: 50px; /* ì•„ì´ì½˜ ê³µê°„ í™•ë³´ */
            border: none;
            border-radius: 10px;
            background-color: #F6F6F6;
            font-size: 16px;
            color: #666;
            outline: none;
        }
        .search-input::placeholder {
            color: #BDBDBD;
        }
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 18px;
            cursor: pointer;
        }
    </style>

    <!-- ì¹´ì¹´ì˜¤ ì§€ë„ API ë¡œë“œ -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=4b49a140b08c89cf9a1287842b76acfc&libraries=services"></script>

</head>
<body>
<div layout:fragment="content">
    <h4>ğŸ“ ì§€ë„ì—ì„œ ë³‘ì› ì°¾ê¸°</h4>

    <div class="search-container">
        <div class="search-box">
            <input type="search" id="search-input" class="search-input" placeholder="ë³‘ì›ì´ë¦„, ì£¼ì†Œ" required onkeydown="handleEnter(event)">
            <i class="fa-solid fa-magnifying-glass search-icon" onclick="searchHospitalByName()"></i>
        </div>
    </div>

    <div class="mt-4" id="map"></div>

    <script>
        let map, infowindow;
        let hospitalMarkers = [];

        // ì¹´ì¹´ì˜¤ ì§€ë„ APIê°€ ë¡œë“œë˜ë©´ initMap ì‹¤í–‰
        kakao.maps.load(function() {
            getUserLocation();
        });

        function initMap(lat, lng) {
            console.log(`ì‚¬ìš©ì ìœ„ì¹˜: ${lat}, ${lng}`);

            const userLocation = new kakao.maps.LatLng(lat, lng);
            const mapContainer = document.getElementById('map');
            const mapOptions = {
                center: userLocation,
                level: 5
            };

            // ì§€ë„ ìƒì„±
            map = new kakao.maps.Map(mapContainer, mapOptions);
            infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });

            // ì´ˆê¸° ë³‘ì› ê²€ìƒ‰
            searchNearbyHospitals();

            // ì§€ë„ ì´ë™ í›„ ìƒˆë¡œìš´ ì¤‘ì‹¬ ì¢Œí‘œë¡œ ë³‘ì› ê²€ìƒ‰
            kakao.maps.event.addListener(map, 'idle', function () {
                console.log("ì§€ë„ ì´ë™ í›„ ê²€ìƒ‰ ì‹¤í–‰");
                searchNearbyHospitals();
            });
        }

        function getUserLocation() {
            console.log("ì‚¬ìš©ì ìœ„ì¹˜ ì°¾ëŠ” ì¤‘...");
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        initMap(lat, lng);
                    },
                    function () {
                        console.error("âŒ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ. ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸ ì‹œì²­) ì‚¬ìš©");
                        initMap(37.5665, 126.9780);
                    }
                );
            } else {
                console.error("âŒ ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ.");
                initMap(37.5665, 126.9780);
            }
        }

        function searchNearbyHospitals() {
            console.log("ë³‘ì› ê²€ìƒ‰ ì‹œì‘");

            const places = new kakao.maps.services.Places();
            const bounds = map.getBounds(); // í˜„ì¬ ì§€ë„ ë²”ìœ„ ê°€ì ¸ì˜¤ê¸°
            console.log("ê²€ìƒ‰ ë²”ìœ„:", bounds);

            places.keywordSearch("ë³‘ì›", function (data, status) {
                if (status === kakao.maps.services.Status.OK) {
                    console.log(`ê²€ìƒ‰ëœ ë³‘ì› ê°œìˆ˜: ${data.length}`);

                    removeMarkers(); // ê¸°ì¡´ ë§ˆì»¤ ì œê±°

                    data.forEach(hospital => {
                        addHospitalMarker(hospital);
                    });
                } else {
                    console.log("âŒ ë³‘ì› ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ");
                }
            }, {
                bounds: map.getBounds() // í˜„ì¬ ë³´ì´ëŠ” ì§€ë„ ì˜ì—­ ë‚´ì—ì„œ ê²€ìƒ‰
            });
        }

        function handleEnter(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                searchHospitalByName(); // ì—”í„° ì…ë ¥ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
            }
        }

        function searchHospitalByName() {
            const hospitalName = document.getElementById("search-input").value.trim();
            if (hospitalName === "") {
                alert("ë³‘ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");
                return;
            }

            console.log(`ğŸ” "${hospitalName}" ê²€ìƒ‰ ì¤‘...`);
            const places = new kakao.maps.services.Places();

            places.keywordSearch(hospitalName, function (data, status) {
                if (status === kakao.maps.services.Status.OK) {
                    console.log(`"${hospitalName}" ê²€ìƒ‰ ê²°ê³¼ ${data.length}ê°œ`);

                    removeMarkers(); // ê¸°ì¡´ ë§ˆì»¤ ì œê±°

                    const hospital = data[0]; // ì²« ë²ˆì§¸ ê²€ìƒ‰ ê²°ê³¼ ì‚¬ìš©
                    const hospitalPosition = new kakao.maps.LatLng(hospital.y, hospital.x);

                    // ì§€ë„ ì¤‘ì‹¬ ì´ë™
                    map.setCenter(hospitalPosition);
                    map.setLevel(3); // ì¤Œ í™•ëŒ€

                    addHospitalMarker(hospital);
                } else {
                    alert("âŒ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
            });
        }

        function addHospitalMarker(hospital) {
            const hospitalPosition = new kakao.maps.LatLng(hospital.y, hospital.x);
            const marker = new kakao.maps.Marker({
                position: hospitalPosition,
                map: map
            });

            kakao.maps.event.addListener(marker, 'click', function () {
                const content = `
                    <div style="padding:5px;font-size:14px;">
                        <strong>${hospital.place_name}</strong><br>
                        ${hospital.road_address_name || hospital.address_name} <br>
                        <a href="${hospital.place_url}" target="_blank" style="color:blue; text-decoration:none;">
                            <span class="text-muted">ìƒì„¸ ì •ë³´ ë³´ê¸°</span>
                        </a>
                    </div>`;
                infowindow.setContent(content);
                infowindow.open(map, marker);
            });

            hospitalMarkers.push(marker);
        }

        function removeMarkers() {
            hospitalMarkers.forEach(marker => marker.setMap(null));
            hospitalMarkers = [];
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
        window.onload = function() {
            kakao.maps.load(function() {
                getUserLocation();
            });
        };
    </script>
</div>
</body>
</html>
